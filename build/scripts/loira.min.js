var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){!function(t){t.ERROR_MESSAGE="error:message",t.OBJECT_ADDED="object:added",t.OBJECT_PRE_ADD="object:pre-add",t.RELATION_PRE_ADD="relation:pre-add",t.RELATION_ADDED="relation:added",t.OBJECT_REMOVED="object:removed";var e=function(){},i=function(n){function t(t,e){var i=n.call(this)||this;return i.x=t,i.y=e,i}return __extends(t,n),t}(t.Event=e);t.MouseEvent=i;var n=function(i){function t(t){var e=i.call(this)||this;return e.selected=t,e}return __extends(t,i),t}(e);t.ObjectEvent=n;var o=function(i){function t(t){var e=i.call(this)||this;return e.selected=t,e}return __extends(t,i),t}(e);t.RelationEvent=o;var r=function(i){function t(t){var e=i.call(this)||this;return e.message=t,e}return __extends(t,i),t}(e);t.MessageEvent=r}(t.event||(t.event={}))}(Loira||(Loira={})),function(t){var e;(e=t.drawable||(t.drawable={})).registerMap=function(t,e,i){this.image=new Image,this.image.src=t,this.image.onload=function(){i()},this.regions=e},e.render=function(t,e,i,n){var o=this.regions[t];e.drawImage(this.image,o.x,o.y,o.width,o.height,i,n,o.width,o.height)},e.get=function(t){return this.regions[t]}}(Loira||(Loira={})),function(t){var e,i,n;e=t.shape||(t.shape={}),(i=e.HorizontalAlign||(e.HorizontalAlign={}))[i.LEFT=0]="LEFT",i[i.CENTER=1]="CENTER",i[i.RIGHT=2]="RIGHT",(n=e.VerticalAlign||(e.VerticalAlign={}))[n.TOP=0]="TOP",n[n.MIDDLE=1]="MIDDLE",n[n.BOTTOM=2]="BOTTOM",e.drawRoundRect=function(t,e,i,n,o,r){t.beginPath(),t.moveTo(e+r,i),t.lineTo(e+n-r,i),t.quadraticCurveTo(e+n,i,e+n,i+r),t.lineTo(e+n,i+o-r),t.quadraticCurveTo(e+n,i+o,e+n-r,i+o),t.lineTo(e+r,i+o),t.quadraticCurveTo(e,i+o,e,i+o-r),t.lineTo(e,i+r),t.quadraticCurveTo(e,i,e+r,i),t.closePath(),t.stroke(),t.fill()},e.drawDiamond=function(t,e,i,n,o){var r=e+n/2,s=i+o/2,a=e+n,h=i+o;t.beginPath(),t.lineWidth=2,t.moveTo(r,i),t.lineTo(a,s),t.lineTo(r,h),t.lineTo(e,s),t.lineTo(r,i),t.stroke(),t.fillStyle="#fcf5d9",t.fill()},e.drawText=function(t,e,i){}}(Loira||(Loira={})),function(v){var l=v.event.RelationEvent,c=v.event.ObjectEvent,t=function(){this.x=0,this.y=0,this.width=0,this.height=0,this.viewportWidth=0,this.viewportHeight=0,this.area=0};v.VirtualCanvas=t;var n,e,o=function(){this.width=0,this.height=0,this.viewportWidth=0,this.viewportHeight=0,this.dragCanvas=!1,this.controller=null,this.readOnly=!1};v.CanvasConfig=o,(e=n=v.UserAgent||(v.UserAgent={}))[e.FIREFOX=1]="FIREFOX",e[e.IE=2]="IE",e[e.CHROME=3]="CHROME",e[e.UNKNOWN=4]="UNKNOWN";var r=function(){},s=function(){function t(t){this._canvas=t,this._scale=1,this.update(1)}return t.prototype.update=function(t){this._scale+=t/Math.abs(t),this._scale<9&&0<this._scale&&(this.scrollX=Math.floor(this._canvas.width/20),this.scrollY=Math.floor(this._canvas.height/20))},t}();var i=function(){function t(t,e){var i;this._selected=[],this._tmp=new r,this.items=[],this._canvas=null,this._background=null,this.virtualCanvas=null,this.defaultRelation=null,this.container=null,this.readOnly=!1,this.container="string"==typeof t?document.getElementById(t):t,e||((e=new o).width=this.container.parentElement.offsetWidth,e.height=this.container.parentElement.offsetHeight),e.viewportWidth=e.viewportWidth||this.container.offsetWidth||this.container.parentElement.offsetWidth||e.width,e.viewportHeight=e.viewportHeight||this.container.offsetHeight||this.container.parentElement.offsetHeight||e.height,this.readOnly=e.readOnly||!1,this._tmp.pointer={x:0,y:0},this._callbacks={},this.items=[],this.width=e.width,this.height=e.height,this.viewportHeight=e.viewportHeight,this.viewportWidth=e.viewportWidth,this.dragCanvas=e.dragCanvas,this.defaultRelation="Relation.Association",this.keyboard=new v.Keyboard(this),this.mouse=new v.Mouse(this),this.refreshScreen(),v.drawable.registerMap(v.Config.assetsPath,v.Config.regions,function(){}),this._zoom=new s(this),this.controller=e.controller||null,this.controller&&this.controller.bind(this),this.userAgent=(i=/firefox/i.test(navigator.userAgent)?n.FIREFOX:n.UNKNOWN,v.util.logger(v.LogLevel.SYSTEM,navigator.userAgent),i),this.bindResizeWindow(),this.initializeRefresher(),this.createHtmlElements()}return Object.defineProperty(t.prototype,"selected",{get:function(){return this._selected},enumerable:!0,configurable:!0}),t.prototype.iterateSelected=function(t){if(0<this._selected.length)for(var e=0,i=this._selected;e<i.length;e++){t(i[e])}},t.prototype.clearSelected=function(t){if(void 0===t&&(t=null),t){for(var e=0;e<this._selected.length;e++)if(this._selected[e]._uid===t._uid){this._selected[e].isSelected=!1,this._selected.splice(e,1);break}}else{for(var i=0,n=this._selected;i<n.length;i++){n[i].isSelected=!1}this._selected=[]}},t.prototype.appendSelected=function(t,e){void 0===e&&(e=!1);var i=null;i="[object Array]"!==Object.prototype.toString.call(t)?[t]:t,e&&this.clearSelected();for(var n=0,o=i;n<o.length;n++){var r=o[n];r.isSelected||(r.isSelected=!0,this._selected.push(r))}},t.prototype.refreshScreen=function(){this.destroy(),this.container.style.width=this.container.style.maxWidth=this.viewportWidth+"px",this.container.style.height=this.container.style.maxHeight=this.viewportHeight+"px",this.container.style.position="relative",this.container.style.overflow="hidden",this._canvas=this.createHiDPICanvas(this.viewportWidth,this.viewportHeight),this._canvas.style.position="absolute",this._canvas.style.left="0",this._canvas.style.top="0",this._canvas.style.zIndex="100",this._canvas.style.backgroundColor=v.Config.background,this._canvas.tabIndex=99,this.container.appendChild(this._canvas),this.virtualCanvas={x:0,y:0,viewportWidth:this.viewportWidth,viewportHeight:this.viewportHeight,width:this.width,height:this.height,area:this.viewportHeight*this.viewportWidth},document.defaultView&&document.defaultView.getComputedStyle&&(this._border={paddingLeft:parseInt(document.defaultView.getComputedStyle(this._canvas,null).paddingLeft,10)||0,paddingTop:parseInt(document.defaultView.getComputedStyle(this._canvas,null).paddingTop,10)||0,borderLeft:parseInt(document.defaultView.getComputedStyle(this._canvas,null).borderLeftWidth,10)||0,borderTop:parseInt(document.defaultView.getComputedStyle(this._canvas,null).borderTopWidth,10)||0}),this.bind(),this._scrollBar=new v.Common.ScrollBar(this)},t.prototype.createHiDPICanvas=function(t,e,i){var n,o,r=(n=document.createElement("canvas").getContext("2d"),(o=(o=window.devicePixelRatio||1)<1?1:o)/(n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1));i||(i=r);var s=document.createElement("canvas");return s.width=t*i,s.height=e*i,s.style.width=t+"px",s.style.height=e+"px",s.getContext("2d").setTransform(i,0,0,i,0,0),s},t.prototype.updater=function(){v.util.logger(v.LogLevel.INFO,"Draw");var e=this,i=1==this._selected.length,n=this._canvas.getContext("2d");n.clearRect(0,0,this._canvas.width,this._canvas.height);for(var t=0;t<this.items.length;t++)this.items[t].isVisible(this.virtualCanvas)&&(n.save(),this.items[t].render(n,this.virtualCanvas.x,this.virtualCanvas.y),n.restore());this.iterateSelected(function(t){t.selectable&&(v.util.logger(v.LogLevel.INFO,"Selected"),n.save(),t.drawSelected(n,i),n.restore(),t.renderButtons(n,e.virtualCanvas.x,e.virtualCanvas.y))}),this._scrollBar.render(n),v.Config.showBanner&&v.Canvas.drawBanner(n)},t.prototype.renderAll=function(t){void 0===t&&(t=!1)},t.prototype.add=function(t,e){if(void 0===e&&(e=!0),!this.readOnly)for(var i,n=this.items,o=this,r=0,s="[object Array]"!==Object.prototype.toString.call(t)?[t]:t;r<s.length;r++){var a=s[r];if(a.attach(o),"relation"===a.baseType){if(i=a,!o.emit(v.event.RELATION_PRE_ADD,new l(i)))return;var h=n.indexOf(i.start);h=h<n.indexOf(i.end)?h:n.indexOf(i.end),n.splice(h,0,a),o.emit(v.event.RELATION_ADDED,new l(i),e)}else if("container"===a.baseType)n.splice(0,0,a),o.emit("container:added",new c(a),e);else{if(!o.emit("object:pre-add",new c(a)))return;a.centerObject&&(a.x=o.virtualCanvas.viewportWidth/2+o.virtualCanvas.x-a.width/2,a.y=o.virtualCanvas.viewportHeight/2+o.virtualCanvas.y-a.height/2),n.push(a),o.emit("object:added",new c(a),e)}}},t.prototype.remove=function(t,e){void 0===e&&(e=!0);for(var i=this.items,n=0,o=t;n<o.length;n++){var r=o[n],s=[];s.push(i.indexOf(r));for(var a=0;a<i.length;a++)if("relation"===i[a].baseType){var h=i[a];h.start._uid!==r._uid&&h.end._uid!==r._uid||(h.destroy(),s.push(a))}s.sort(function(t,e){return t-e});for(a=s.length-1;0<=a;a--)i.splice(s[a],1);this.emit(v.event.OBJECT_REMOVED,new c(r),e)}this.clearSelected()},t.prototype.removeSelected=function(t){void 0===t&&(t=!0),this.remove(this._selected,t)},t.prototype.removeAll=function(){for(var t=0;t<this.items.length;t++)this.items[t].destroy();this.items=[],this.clearSelected()},t.prototype.destroy=function(){for(this._canvas&&(this._canvas.onmousemove=null,this._canvas.onkeydown=null,this._canvas.onmousedown=null,this._canvas.onmouseup=null,this._canvas.ondblclick=null,this._canvas.onselectstart=null),this.contextMenu&&(this.contextMenu.remove(),this.contextMenu=null),this.textEditor&&(this.textEditor.remove(),this.textEditor=null),this._canvas=null;this.container.firstChild;)this.container.removeChild(this.container.firstChild)},t.prototype.on=function(t,e){var i;if("string"==typeof t)return void 0===this._callbacks[t]&&(this._callbacks[t]=[]),this._callbacks[t].push(e),e;if("object"==typeof t)for(i in t)t.hasOwnProperty(i)&&(void 0===this._callbacks[i]&&(this._callbacks[i]=[]),this._callbacks[i].push(t[i]));return null},t.prototype.fall=function(t,e){var i=this._callbacks[t].indexOf(e);-1<i&&this._callbacks[t].splice(i,1)},t.prototype.createHtmlElements=function(){this.contextMenu=document.createElement("ul"),this.contextMenu.className="loira-context-menu",this.contextMenu.oncontextmenu=function(){return!1},document.getElementsByTagName("body")[0].appendChild(this.contextMenu),this.textEditor=document.createElement("textarea"),this.textEditor.className="loira-text-editor",document.getElementsByTagName("body")[0].appendChild(this.textEditor),this.tooltip=document.createElement("div"),this.tooltip.className="loira-tooltip",document.getElementsByTagName("body")[0].appendChild(this.tooltip)},t.prototype.bind=function(){this.keyboard.bind(),this.mouse.bind(),this._canvas.onselectstart=function(){return!1}},t.prototype.bindResizeWindow=function(){var t=-1,e=this,i=function(){clearTimeout(t),t=setTimeout(function(){e.refreshScreen()},500)};window.removeEventListener("resize",i),window.addEventListener("resize",i)},t.prototype.emit=function(t,e,i){if(void 0===i&&(i=!0),i&&void 0!==this._callbacks[t])for(var n=0,o=this._callbacks[t];n<o.length;n++){if(!1===o[n].call(this,e))return!1}return!0},t.prototype._getMouse=function(t){var e=this._canvas,i=0,n=0;if(e.offsetParent){for(;i+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;);for(e=this._canvas;"BODY"!==e.nodeName&&(n-=e.scrollTop,i-=e.scrollLeft),e=e.parentElement;);}var o=this._border;i+=o.paddingLeft,n+=o.paddingTop,i+=o.borderLeft,n+=o.borderTop;var r={x:t.pageX-i,y:t.pageY-n};return r.x+=this.virtualCanvas.x,r.y+=this.virtualCanvas.y,r},t.prototype.getGlobalPoint=function(t,e){var i=this._canvas,n=0,o=0;if(i.offsetParent){for(;n+=i.offsetLeft,o+=i.offsetTop,i=i.offsetParent;);for(i=this._canvas;"BODY"!==i.nodeName&&(o-=i.scrollTop,n-=i.scrollLeft),i=i.parentElement;);}var r=this._border;n+=r.paddingLeft,o+=r.paddingTop;var s={x:t+(n+=r.borderLeft),y:e+(o+=r.borderTop)};return s.x-=this.virtualCanvas.x,s.y-=this.virtualCanvas.y,s},t.prototype.removeRelation=function(t,e){for(var i=[],n=0,o=this.getRelationsFromObject(t,!1,!0);n<o.length;n++){var r=o[n];r.end==e&&i.push(r)}0<i.length&&this.remove(i,!1)},t.prototype.setBackground=function(t,e){this._background=this.createHiDPICanvas(t.width,t.height),this._background.style.position="absolute",this._background.style.left="0",this._background.style.top="0",this._background.style.zIndex="0",this._background.getContext("2d").drawImage(t,0,0),this._canvas.style.backgroundColor="transparent",e&&(this.virtualCanvas.width=t.width,this.virtualCanvas.height=t.height,this._scrollBar=new v.Common.ScrollBar(this)),this.container.insertBefore(this._background,this._canvas)},t.prototype.trigger=function(t,e){this.emit(t,new c(e))},t.prototype.cleanBackground=function(){this.container.removeChild(this.container.firstChild),this._canvas.width=this.width,this._canvas.height=this.height,this.container.style.width=this.container.style.maxWidth=this.viewportWidth+"px",this.container.style.height=this.container.style.maxHeight=this.viewportHeight+"px",this._canvas.style.backgroundColor=v.Config.background},t.prototype.getRelationsFromObject=function(t,e,i){for(var n=[],o=0,r=this.items;o<r.length;o++){var s=r[o];if("relation"===s.baseType){var a=s;a.start!==t&&a.end!==t||(a.start===t&&i?n.push(s):a.end===t&&e?n.push(s):e||i||n.push(s))}}return n},t.prototype.centerToPoint=function(t,e){t-=this.virtualCanvas.viewportWidth/2,e-=this.virtualCanvas.viewportHeight/2,this._scrollBar.setPosition(t,e)},t.prototype.setSelectedElement=function(t){this.appendSelected(t,!0)},t.prototype.getContext=function(){return this._canvas.getContext("2d")},t.prototype.getImage=function(t){var e,i,n,o,r,s,a,h;void 0===t&&(t=0);var l=this.items.slice(0);e=i=Number.MIN_VALUE,n=o=Number.MAX_VALUE;for(var c=0,u=l;c<u.length;c++){var d=u[c];"relation"!==d.baseType&&(d.x<n&&(n=d.x),d.y<o&&(o=d.y),d.width+d.x>e&&(e=d.width+d.x),d.y+d.height>i&&(i=d.y+d.height))}r=e-n+10+2*t,s=i-o+10+2*t;var p=this.createHiDPICanvas(r,s,1),f=p.getContext("2d");f.fillStyle=v.Config.background,f.fillRect(0,0,r,s),h=o-t-5,a=n-t-5;for(var y=0;y<l.length;y++)f.save(),l[y].render(f,a,h),f.restore();return p.toDataURL("image/png")},t.prototype.getElementByPosition=function(t,e){for(var i,n=this.items.length-1;0<=n;n--)if((i=this.items[n]).isVisible(this.virtualCanvas)&&i.checkCollision(t,e))return i;return null},t.drawBanner=function(t){t.fillStyle="rgba(0, 0, 0, 0.15)",t.fillRect(0,0,114,16),t.font="12px Arial",t.fillStyle="#FFFFFF",t.fillText("loira-designer v0.5.7",2,12)},t.prototype.showEditor=function(t,e,i){var n=this.getGlobalPoint(t.x,t.y);this.textEditor.style.top=n.y+"px",this.textEditor.style.left=n.x+"px",this.textEditor.style.display="block",this.textEditor.style.width=t.width+"px",this.textEditor.style.height=t.height+"px",this.textEditor.focus(),this.textEditor.value=e;var o=this,r=this.on("mouse:down",function(){o.textEditor.style.display="none",i(o.textEditor.value),o.fall("mouse:down",r)})},t.prototype.restore=function(){},t.prototype.save=function(t){void 0===t&&(t=1)},t.prototype.getSelected=function(){return this._selected},t.prototype.initializeRefresher=function(){var t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},e=this,i=function(){e.updater(),t(i)};i()},t}();v.Canvas=i}(Loira||(Loira={})),function(t){var e=function(){function t(t){this._registers=[],this._element=t}return t.prototype.moveTo=function(t,e,i){void 0===i&&(i=1);this._fps;this._isRunning=!0},t.prototype.setFps=function(t){this._fps=t},t.prototype.proccess=function(){this._isRunning&&0==this._registers.length&&(this._isRunning=!1)},t}();t.Animation=e}(Loira||(Loira={})),function(t){var e=function(){};(Loira||(Loira={})).BaseController=e}();__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(h){!function(t){var e=function(){this.x=0,this.y=0,this.width=0,this.height=0,this.centerObject=!1,this.maxOutGoingRelation=0,this.extras={},this.text="",this.selectable=!0,this.resizable=!0,this.draggable=!0},i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t.BaseOption=e);t.RelOption=i;var n=function(){function t(t,e,i,n){this.x1=t,this.y1=e,this.x2=i,this.y2=n}return t.prototype.xm=function(){return this.x2-this.x1},t.prototype.ym=function(){return this.y2-this.y1},t}();t.Line=n;var o=function(){};t.Region=o;var r=function(t,e){this.x=t,this.y=e};t.Point=r;var s,a=function(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n};t.Rect=a,(s=t.Key||(t.Key={}))[s.ENTER=13]="ENTER",s[s.DELETE=46]="DELETE",s[s.CONTROL=17]="CONTROL",s[s.ALT=18]="ALT",s[s.SHIFT=16]="SHIFT",t.createRandom=function(t){for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<t;n++)e+=i.charAt(Math.floor(Math.random()*i.length));return e},t.createRandomNumber=function(t){return Math.floor(1e7*Math.random())},t.intersectPointLine=function(t,e){var i=(t.y2-t.y1)*(e.x2-e.x1)-(t.x2-t.x1)*(e.y2-e.y1);if(0===i)return!1;var n=e.y1-t.y1,o=e.x1-t.x1;return n=((t.x2-t.x1)*n-(t.y2-t.y1)*o)/i,{x:e.x1+n*(e.x2-e.x1),y:e.y1+n*(e.y2-e.y1)}},t.stringToFunction=function(t){for(var e=t.split("."),i=window||this,n=0,o=e;n<o.length;n++)i=i[o[n]];if("function"!=typeof i)throw new Error("function not found");return i},t.removeWhole=function(t,e){t.sort(function(t,e){return t-e});for(var i=t.length-1;0<=i;i--)e.splice(t[i],1)},t.logger=function(t,e,i){h.Config.debug&&t<=h.Config.logLevel&&console.log("[Loira "+(new Date).getTime()+"] "+e)}}(h.util||(h.util={}))}(Loira||(Loira={})),function(h){var l=h.util.Key,c=h.event.MouseEvent,u=h.event.ObjectEvent,t=function(){function t(t){this.canvas=t,this.isDragged=!1}return t.prototype.bind=function(){var e=this;this.canvas._canvas.onmousewheel=function(t){e.canvas.tooltip.style.display="none",e.onWheel(t)},this.canvas._canvas.onmousedown=function(t){e.onDown(t)},this.canvas._canvas.onmousemove=function(t){e.onMove(t)},this.canvas._canvas.onmouseup=function(t){e.onUp(t)},this.canvas._canvas.onmouseleave=function(t){e.onLeave()},this.canvas._canvas.oncontextmenu=function(t){return e.onContextMenu(t),!1},document.addEventListener("mousemove",function(t){e.canvas.tooltip.style.display="none",e.onMoveGlobal(t)}),document.addEventListener("mouseup",function(t){e.onUpGlobal()})},t.prototype.onDownLocal=function(t,e){var i,n=this.canvas,o=n._getMouse(t);if(n._tmp.pointer=o,e?n.emit("mouse:dblclick",new c(o.x,o.y)):n.emit("mouse:down",new c(o.x,o.y)),e||n.readOnly||(this.isDragged=!0,n._canvas.style.cursor="move"),n._scrollBar.checkCollision(o.x,o.y))return n._tmp.globalPointer={x:t.pageX,y:t.pageY},void(this.isDragged=!0);if(1==n.selected.length&&!n.readOnly){var r=n.selected[0];if(n._tmp.transform=r.getSelectedCorner(o.x,o.y),n._tmp.transform||r.callCustomButton(o.x,o.y)){switch(n._tmp.transform){case"tc":case"bc":n._canvas.style.cursor="ns-resize";break;case"ml":case"mr":n._canvas.style.cursor="ew-resize"}return}n.keyboard.lastKey!==l.SHIFT&&(n.clearSelected(),n.emit("object:unselected",new c(o.x,o.y)))}for(var s=!1,a=n.items.length-1;0<=a;a--)if((i=n.items[a]).checkCollision(o.x,o.y)){if(s=!0,i.isSelected){n.keyboard.lastKey===l.SHIFT&&(n.clearSelected(i),n.emit("object:unselected",new u(i)));break}if(n.appendSelected(i,n.keyboard.lastKey!==l.SHIFT),"relation"!==i.baseType){e?n.emit("object:dblclick",new u(i)):(h.util.logger(h.LogLevel.INFO,"down"),n.emit("object:selected",new u(i)));break}e?n.emit("relation:dblclick",new u(i)):n.emit("relation:selected",new u(i));break}s||(n.clearSelected(),n.emit("object:unselected",new u(null)))},t.prototype.onDown=function(t){h.util.logger(h.LogLevel.INFO,"Mouse"),this.canvas.contextMenu.style.display="none",this.onDownLocal(t,!1)},t.prototype.onMove=function(t){var e=this.canvas,i=this;if(clearTimeout(this.stopTimeout),this.stopTimeout=setTimeout(function(){i.onStop(t)},500),(!this.canvas.readOnly||this.canvas._scrollBar.isSelectable())&&this.isDragged){var n=e._getMouse(t),o=n.x-e._tmp.pointer.x,r=n.y-e._tmp.pointer.y;if(!e._scrollBar.isSelectable()){if(e.emit("mouse:move",new c(n.x,n.y)),e.selected)if(e._tmp.transform)if("relation"!==e.selected[0].baseType)switch(o=Math.floor(o),r=Math.floor(r),e._tmp.transform){case"tc":e.selected[0].y+=r,e.selected[0].height-=r;break;case"bc":e.selected[0].height+=r;break;case"ml":e.selected[0].x+=o,e.selected[0].width-=o;break;case"mr":e.selected[0].width+=o}else e.selected[0].movePoint(parseInt(e._tmp.transform),o,r);else e.iterateSelected(function(t){t.draggable&&(t.x+=o,t.y+=r,e.emit("object:dragging",new u(t)))});e._tmp.pointer=n}}},t.prototype.onUp=function(t){var e=this.canvas._getMouse(t);this.canvas._canvas.style.cursor="default",this.isDragged=!1,this.canvas.emit("mouse:up",new c(e.x,e.y));var i=this.canvas;this.canvas.iterateSelected(function(t){i.emit("object:released",new u(t)),i._tmp.transform=null,t.recalculateBorders()})},t.prototype.onLeave=function(){this.isDragged=!1,this.canvas._canvas.style.cursor="default"},t.prototype.onWheel=function(t){return t.ctrlKey?this.canvas._zoom.update(t.deltaY):this.canvas._scrollBar.addMovementWheel(t.shiftKey,t.deltaY/Math.abs(t.deltaY)),!1},t.prototype.onMoveGlobal=function(t){this.canvas._scrollBar.isSelectable()&&(this.canvas._scrollBar.dragScroll(t.pageX-this.canvas._tmp.globalPointer.x,t.pageY-this.canvas._tmp.globalPointer.y),this.canvas._tmp.globalPointer={x:t.pageX,y:t.pageY})},t.prototype.onUpGlobal=function(){this.canvas._scrollBar.selected=null},t.prototype.onStop=function(t){var e=this.canvas._getMouse(t),i=this.canvas.getElementByPosition(e.x,e.y),n=this.canvas;if(i){var o=i.getTooltip(e.x,e.y);"string"==typeof o?n.tooltip.innerHTML=o:n.tooltip.appendChild(o),n.tooltip.style.top=t.clientY+30+"px",n.tooltip.style.left=t.clientX+"px",n.tooltip.style.display="block",n.tooltip.style.opacity="1"}},t.prototype.onContextMenu=function(t){var e=this.canvas;e.contextMenu.style.display="none";var i=e._getMouse(t),n=e.getElementByPosition(i.x,i.y);if(n){var o=n.getMenu(i.x,i.y);if(!o)return!1;var r=void 0;e.contextMenu.innerHTML="";for(var s=function(t){r=document.createElement("li"),t?(r.innerHTML=t.text,r.onclick=function(){t.callback(this,n),e.contextMenu.style.display="none"}):r.className="null-line",e.contextMenu.appendChild(r)},a=0,h=o;a<h.length;a++){s(h[a])}e.contextMenu.style.top=t.clientY+"px",e.contextMenu.style.left=t.clientX+"px",e.contextMenu.style.display="block",e.contextMenu.style.opacity="1"}},t}();h.Mouse=t}(Loira||(Loira={})),function(t){var i=t.util.Key,e=function(){function t(t){this.canvas=t,this.onKeyUp=function(t){this.canvas.readOnly||(this.LastKey=null)}}return t.prototype.bind=function(){var e=this,t=this.canvas._canvas;t.onkeydown=function(t){e.onKeyDown(t,!1)},document.addEventListener("keydown",function(t){e.onKeyDown(t,!0)}),t.onkeyup=function(t){e.onKeyUp(t)},document.addEventListener("keyup",function(t){e.onKeyUp(t)})},t.prototype.onKeyDown=function(t,e){if(t.keyCode!==i.ALT&&(this.lastKey=t.keyCode,!e&&this.lastKey===i.DELETE)){if(this.canvas.readOnly)return;this.canvas.removeSelected(!1)}},t}();t.Keyboard=e}(Loira||(Loira={})),function(h){var e=h.util.BaseOption,t=function(){function t(t){this._uid=h.util.createRandom(8),void 0===t&&(t=new e),this.x="x"in t?t.x:0,this.y="y"in t?t.y:0,this.width="width"in t?t.width:0,this.height="height"in t?t.height:0,this.centerObject="centerObject"in t&&t.centerObject,this.maxOutGoingRelation="maxOutGoingRelation"in t?t.maxOutGoingRelation:0,this.extras="extras"in t?t.extras:{},this.text=t.text?t.text:"",this.selectable=!t.selectable||t.selectable,this.resizable=!t.resizable||t.resizable,this.draggable=!t.draggable||t.draggable,this._buttons=[],this._canvas=null,this.type="",this.baseType="",this.isSelected=!1}return t.prototype.render=function(t,e,i){},t.prototype.checkCollision=function(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height},t.prototype.on=function(t){this._buttons=t?t=[].splice.call(arguments,0):[]},t.prototype.moveTo=function(t,e,i){void 0===i&&(i=!1),i?(this.destinationPoint.x=t,this.destinationPoint.y=e):(this.destinationPoint.x=this.x+t,this.x+=t,this.y+=e)},t.prototype.renderButtons=function(e,t,i){var n=this.x+this.width+10,o=this.y;n-=t,o-=i,0<this._buttons.length&&this._buttons.forEach(function(t){h.drawable.render(t.icon,e,n,o),o+=h.drawable.get(t.icon).height+4})},t.prototype.callCustomButton=function(t,e){for(var i,n=this.x+this.width+10,o=this.y,r=0,s=this._buttons;r<s.length;r++){var a=s[r];if(i=h.drawable.get(a.icon),n<=t&&t<=n+i.width&&o<=e&&e<=o+i.height)return a.click.call(this),!0;o+=a.icon.height+4}return!1},t.prototype.drawSelected=function(t,e){void 0===e&&(e=!0);var i=this.x-2,n=this.y-2,o=this.width,r=this.height;i-=this._canvas.virtualCanvas.x,n-=this._canvas.virtualCanvas.y,t.beginPath(),t.lineWidth=2,t.setLineDash([5,5]),t.strokeStyle=h.Config.selected.color,t.rect(i,n,o+4,r+4),t.stroke(),t.setLineDash([]),this.resizable&&e&&(t.fillStyle=h.Config.selected.color,t.fillRect(i-4,n-4,8,8),t.fillRect(i+o,n+r,8,8),t.fillRect(i+o,n-4,8,8),t.fillRect(i-4,n+r,8,8),t.fillRect(i+o/2,n-4,8,8),t.fillRect(i+o/2,n+r,8,8),t.fillRect(i-4,n+r/2,8,8),t.fillRect(i+o,n+r/2,8,8)),t.strokeStyle="#000000",t.fillStyle="#000000"},t.prototype.getSelectedCorner=function(t,e){if(!this.resizable)return"";var i=this.x-2,n=this.y-2,o=this.width,r=this.height,s=o/2,a=r/2;return i-4<=t&&t<=i+4&&n-4<=e&&e<=n+4?"tl":i+o<=t&&t<=i+o+8&&n-4<=e&&e<=n+4?"tr":i+o<=t&&t<=i+o+8&&n+r<=e&&e<=n+r+8?"br":i-4<=t&&t<=i+4&&n+r<=e&&e<=n+r+8?"bl":i+s<=t&&t<=i+s+8&&n-4<=e&&e<=n+4?"tc":i+s<=t&&t<=i+s+8&&n+r<=e&&e<=n+r+8?"bc":i-4<=t&&t<=i+4&&n+a<=e&&e<=n+a+8?"ml":i+o<=t&&t<=i+o+8&&n+a<=e&&e<=n+a+8?"mr":""},t.prototype.show=function(){this._canvas.centerToPoint(this.x+this.width/2,this.y+this.height/2)},t.prototype.attach=function(t){this._canvas=t},t.prototype.isVisible=function(t){var e=null,i=null,n=null,o=null;return t.area>this.width*this.height?(e={x:this.x,y:this.y},i={x:this.x+this.width,y:this.y+this.height},n={x:t.x,y:t.y},o={x:t.x+t.viewportWidth,y:t.y+t.viewportHeight}):(n={x:this.x,y:this.y},o={x:this.x+this.width,y:this.y+this.height},e={x:t.x,y:t.y},i={x:t.x+t.viewportWidth,y:t.y+t.viewportHeight}),e.x>n.x&&e.x<o.x&&e.y>n.y&&e.y<o.y||(e.x>n.x&&e.x<o.x&&i.y>n.y&&i.y<o.y||(i.x>n.x&&i.x<o.x&&e.y>n.y&&e.y<o.y||i.x>n.x&&i.x<o.x&&i.y>n.y&&i.y<o.y))},t.prototype.destroy=function(){this._canvas=null},t.prototype.getMenu=function(t,e){return this.menu},t.prototype.getTooltip=function(t,e){return"Tipo: <b>"+this.type+"</b>"},t}();h.Element=t}(Loira||(Loira={}));var Loira;__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(P){!function(t){var o,e,r=P.util.Point,T=P.util.Line,n=P.util.BaseOption,L=P.util.Rect;(e=o=t.TypeLine||(t.TypeLine={}))[e.STRAIGHT=1]="STRAIGHT",e[e.CURVE=2]="CURVE",e[e.CARTESIAN=3]="CARTESIAN";var i=function(n){function t(t){var e=n.call(this,t)||this;e.start=t.start?t.start:null,e.end=t.end?t.end:null,e.isDashed=!!t.isDashed&&t.isDashed,e.points=t.points?t.points:[new r,new r],e.icon=t.icon?t.icon:"",e.typeLine=t.typeLine?t.typeLine:o.STRAIGHT,e.baseType="relation";var i=e;return e.menu=[{text:"Partir",callback:function(){i.addPoint()}},{text:"Borrar",callback:function(){i._canvas.remove([i])}}],e.pointMenu=[{text:"Borrar punto",callback:function(){i.removePoint(i.selectedArea)}}],e.start&&e.end&&e.start._uid===e.end._uid&&e.selfRelated(),e}return __extends(t,n),t.prototype.render=function(t,e,i){var n,o,r,s,a,h,l,c,u=[],d=0;n=new L(this.start.x,this.start.y,this.start.width,this.start.height),o=new L(this.end.x,this.end.y,this.end.width,this.end.height),this.points[0]={x:n.x+n.width/2,y:n.y+n.height/2},this.points[this.points.length-1]={x:o.x+o.width/2,y:o.y+o.height/2},s=this.points[0],a=this.points[1],t.beginPath(),t.lineWidth=1,t.moveTo(s.x-e,s.y-i),this.isDashed&&t.setLineDash([5,5]);for(var p=0;p<this.points.length;p++)t.lineTo(this.points[p].x-e,this.points[p].y-i),0<p&&(u[p-1]=Math.sqrt(Math.pow(this.points[p].x-this.points[p-1].x,2)+Math.pow(this.points[p].y-this.points[p-1].y,2)),d+=u[p-1]);if(t.stroke(),t.setLineDash([]),this.icon){s=this.points[this.points.length-2],h=(a=this.points[this.points.length-1]).x-s.x,l=a.y-s.y,r=Math.atan(l/h),h<0&&(r+=Math.PI),t.translate(a.x-e,a.y-i),t.rotate(r),c=new T(s.x,s.y,a.x,a.y);var f=P.drawable.get(this.icon),y=this.end.obtainBorderPos(c,t);P.drawable.render(this.icon,t,-(f.width+y),-Math.ceil(f.height/2)),t.rotate(-r),t.translate(-a.x-e,-a.y-i)}if(this.text||0<this.text.length){t.font=P.Config.fontSize+"px "+P.Config.fontType;var v=0,g=0,x=0;if(2==this.points.length)s=this.points[0],a=this.points[1],c=new T(s.x,s.y,a.x,a.y),v=this.end.obtainBorderPos(c,t),g=this.start.obtainBorderPos(c,t);else{x=(d-(g=this.start.obtainBorderPos(new T(this.points[0].x,this.points[0].y,this.points[1].x,this.points[1].y),t))-(v=this.end.obtainBorderPos(new T(this.points[this.points.length-2].x,this.points[this.points.length-2].y,this.points[this.points.length-1].x,this.points[this.points.length-1].y),t)))/2+g;for(p=0;0<x-u[p];)x-=u[p],p++;s=this.points[p],a=this.points[p+1],0!==p&&(g=0),p!==this.points.length-2&&(v=0)}var _=a.x-s.x,m=a.y-s.y,w=Math.sqrt(Math.pow(_,2)+Math.pow(m,2)),b=2==this.points.length?(w-v-g)/2+g:x,C=Math.floor(m/w*b),S=Math.floor(_/w*b);r=t.measureText(this.text).width,t.fillStyle=P.Config.background,t.fillRect(s.x+e+S-r/2,s.y+i+C-13,r,12),t.fillStyle="#000000",t.fillText(this.text,s.x+e+S-r/2,s.y+i+C-3),t.font=P.Config.fontSize+"px "+P.Config.fontType}},t.prototype.recalculateBorders=function(){},t.prototype.update=function(t,e){return this.start=t,this.end=e,this.start&&this.end&&this.start._uid===this.end._uid&&this.selfRelated(),this},t.prototype.checkCollision=function(t,e){for(var i,n=null,o=null,r=0,s=0,a={x:0,y:0},h={x:0,y:0},l=0,c=0,u=1;u<this.points.length;u++)if(n=this.points[u-1],o=this.points[u],a.x=n.x,a.y=n.y,h.y=o.y,h.x=o.x,n.x>o.x&&(a.x=o.x,h.x=n.x),n.y>o.y&&(a.y=o.y,h.y=n.y),t>a.x-5&&t<h.x+5&&e>a.y-5&&e<h.y+5)if(s=Math.abs(o.y-n.y),r=Math.abs(o.x-n.x),l=Math.abs(t-n.x),c=Math.abs(e-n.y),s<r){if(0===(i=Math.abs(s/r*l))&&c>a.y&&c<h.y||c-8<i&&i<c+8)return!0}else if(0===(i=Math.abs(r/s*c))&&l>a.x&&l<h.x||l-8<i&&i<l+8)return!0;return!1},t.prototype.drawSelected=function(t){t.beginPath(),t.fillStyle=P.Config.selected.color;for(var e=this._canvas.virtualCanvas.x,i=this._canvas.virtualCanvas.y,n=0;n<this.points.length;n++)t.fillRect(this.points[n].x-4-e,this.points[n].y-4-i,8,8);t.strokeStyle="#000000"},t.prototype.addPoint=function(){var t=this.points[1],e=this.points[0],i=Math.round((t.x-e.x)/2)+e.x,n=Math.round((t.y-e.y)/2)+e.y;this.points.splice(1,0,{x:i,y:n})},t.prototype.removePoint=function(t){this.points.splice(t,1)},t.prototype.getSelectedCorner=function(t,e){for(var i=1;i<this.points.length-1;i++){var n=this.points[i].x-4,o=this.points[i].y-4;if(n<t&&t<n+8&&o<e&&e<o+8)return i}return!1},t.prototype.movePoint=function(t,e,i){this.points[t].x+=e,this.points[t].y+=i},t.prototype.isVisible=function(t){return!0},t.prototype.getMenu=function(t,e){return this.selectedArea=this.getSelectedCorner(t,e),this.selectedArea&&this.pointMenu||this.menu},t.prototype.move=function(t,e){if(2<this.points.length)for(var i=1;i<this.points.length-1;i++)this.points[i].x+=t,this.points[i].y+=e},t.prototype.selfRelated=function(){var t=this.start.x+this.start.width+30,e=this.start.y+this.start.height/2;this.points=[],this.points.push(new r),this.points.push(new r(t,e)),this.points.push(new r(t,this.start.y-30)),this.points.push(new r(this.start.x+this.start.width/2,this.start.y-30)),this.points.push(new r)},t}(P.Element);t.Relation=i;var s=function(o){function t(t){var e=o.call(this,t)||this,i=e._linkSymbol;e.on({icon:"arrow",click:i}),e.baseType="symbol";var n=e;return e.menu=[{text:P.Config.workflow.menu.joinTo,callback:function(){n._linkSymbol()}},{text:P.Config.workflow.menu.deleteBtn,callback:function(){n._canvas.remove([n])}}],e}return __extends(t,o),t.prototype._linkSymbol=function(){var a=this,h=this._canvas.on("mouse:down",function(t){var e=a._canvas,i=e.getRelationsFromObject(a,!1,!0).length;if(!a.maxOutGoingRelation||i<a.maxOutGoingRelation)for(var n=0,o=e.items;n<o.length;n++){var r=o[n];if("relation"!==r.baseType&&r.checkCollision(t.x,t.y)){var s=P.util.stringToFunction(e.defaultRelation);e.add(new s({}).update(a,r));break}}e.fall("mouse:down",h)})},t.prototype.splitText=function(t,e,i){void 0===i&&(i=10);for(var n=e.split(" "),o="",r=[],s=0;s<n.length;s++)o=t.measureText(o+n[s]).width>this.width-i?(r.push(o),n[s]+" "):o+" "+n[s];return r.push(o),r},t.prototype.drawText=function(t,e,i,n){var o,r,s=this.x-i+this.width/2;o=this.y-n+this.height/2+3-(6*(r=this.splitText(t,e)).length+3*r.length)/2;for(var a=0;a<r.length;a++){var h=t.measureText(r[a]).width;t.fillText(r[a],s-h/2,o+3),o=o+P.Config.fontSize+3}},t}(P.Element);t.Symbol=s;var a=function(i){function t(t){var e=i.call(this,t)||this;return e.text=t.text?t.text:"Actor1",e.width=30,e.height=85,e.type="actor",e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){e.font=P.Config.fontSize+"px "+P.Config.fontType;var i=e.measureText(this.text).width,n=t.x2-t.x1,o=t.y2-t.y1;i>this.width&&(this.x=this.x+this.width/2-i/2,this.width=i);var r=Math.atan(o/n);n<0&&(r+=Math.PI);var s=null;return s=-.8<r&&r<.68||2.46<r&&r<4?P.util.intersectPointLine(t,new T(this.x,-100,this.x,100)):P.util.intersectPointLine(t,new T(-100,this.y,100,this.y)),Math.sqrt(Math.pow(s.x-(this.x+this.width/2),2)+Math.pow(s.y-(this.y+this.height/2),2))},t.prototype.render=function(t,e,i){var n=t.measureText(this.text).width;n>this.width&&(this.x=this.x+this.width/2-n/2,this.width=n);var o=this.x-e,r=this.y-i;t.fillStyle=P.Config.background,t.fillRect(o,r,this.width,this.height),t.fillStyle="#000000",P.drawable.render("actor",t,o+this.width/2-15,r),t.font=P.Config.fontSize+"px "+P.Config.fontType,t.fillStyle="#000000",t.fillText(this.text,o,r+80)},t.prototype.recalculateBorders=function(){},t}(t.Symbol);t.Actor=a;var h=function(i){function t(t){var e=i.call(this,new n)||this;return e.type="scrollBar",e.width=t.virtualCanvas.viewportWidth,e.height=t.virtualCanvas.viewportHeight,e._horPos=t.virtualCanvas.x,e._verPos=t.virtualCanvas.y,e._horSize=Math.floor(e.width*(e.width/t.virtualCanvas.width)),e._verSize=Math.floor(e.height*(e.height/t.virtualCanvas.height)),e._virtual=t.virtualCanvas,e._canvas=t,e}return __extends(t,i),t.prototype.render=function(t){var e=P.Config.scrollBar;this._virtual.width>this._virtual.viewportWidth&&(t.fillStyle=e.background,t.fillRect(0,this.height-e.size,this._virtual.viewportWidth,e.size),t.fillStyle=e.color,t.fillRect(this._horPos,this.height-e.size,this._horSize,e.size)),this._virtual.height>this._virtual.viewportHeight&&(t.fillStyle=e.background,t.fillRect(this.width-e.size,0,e.size,this._virtual.viewportHeight),t.fillStyle=e.color,t.fillRect(this.width-e.size,this._verPos,e.size,this._verSize)),t.fillStyle="#000000"},t.prototype.recalculateBorders=function(){},t.prototype.checkCollision=function(t,e){var i=this._virtual,n=t-i.x,o=e-i.y;return n>this._horPos&&n<this._horPos+this._horSize&&o>i.viewportHeight-P.Config.scrollBar.size&&o<i.viewportHeight?(this.selected="H",!0):n>i.viewportWidth-P.Config.scrollBar.size&&n<i.viewportWidth&&o>this._verPos&&o<this._verPos+this._verSize?(this.selected="V",!0):(this.selected=null,!1)},t.prototype.addMovement=function(t,e,i){var n;void 0===i&&(i=30);var o=this._virtual,r=this._canvas._background;"H"===t?((n=this._horPos+e*i)<0?this._horPos=0:n+this._horSize>o.viewportWidth?this._horPos=o.viewportWidth-this._horSize:this._horPos=n,o.x=Math.floor(o.width*(this._horPos/o.viewportWidth)),r&&(r.style.marginLeft="-"+o.x+"px")):"V"===t&&((n=this._verPos+e*i)<0?this._verPos=0:n+this._verSize>o.viewportHeight?this._verPos=o.viewportHeight-this._verSize:this._verPos=n,o.y=Math.floor(o.height*(this._verPos/o.viewportHeight)),r&&(r.style.marginTop="-"+o.y+"px"))},t.prototype.addMovementWheel=function(t,e,i){var n;void 0===i&&(i=30);var o=this._virtual,r=this._canvas._background;t?((n=this._horPos+Math.round(e*o.viewportWidth*(i/o.width)))<0?this._horPos=0:n+this._horSize>o.viewportWidth?this._horPos=o.viewportWidth-this._horSize:this._horPos=n,o.x=Math.floor(o.width*(this._horPos/o.viewportWidth)),r&&(r.style.marginLeft="-"+o.x+"px")):((n=this._verPos+Math.round(e*o.viewportHeight*(i/o.height)))<0?this._verPos=0:n+this._verSize>o.viewportHeight?this._verPos=o.viewportHeight-this._verSize:this._verPos=n,o.y=Math.floor(o.height*(this._verPos/o.viewportHeight)),r&&(r.style.marginTop="-"+o.y+"px"))},t.prototype.setPosition=function(t,e){var i=this._virtual,n=this._canvas._background;t=t<0?0:t,e=e<0?0:e,i.x=t,i.y=e,this._horPos=Math.floor(i.x*i.viewportWidth/i.width),this._verPos=Math.floor(i.y*i.viewportHeight/i.height),n&&(n.style.marginTop="-"+i.y+"px",n.style.marginLeft="-"+i.x+"px")},t.prototype.isSelectable=function(){return!!this.selected},t.prototype.dragScroll=function(t,e){this.addMovement(this.selected,"H"===this.selected?t:e,1)},t}(P.Element);t.ScrollBar=h}(P.Common||(P.Common={}))}(Loira||(Loira={})),function(t){var e,i,n,o={color:"#339966"},r={actor:{x:0,y:30,width:30,height:60},spear:{x:0,y:0,width:14,height:15},spear1:{x:0,y:15,width:15,height:15},spear2:{x:15,y:0,width:15,height:15},spear3:{x:30,y:15,width:15,height:15},arrow:{x:15,y:15,width:15,height:15},start1:{x:30,y:15,width:15,height:15},end1:{x:30,y:30,width:15,height:15},start2:{x:30,y:45,width:15,height:15},end2:{x:30,y:60,width:15,height:15}},s={size:10,color:"rgba(255, 255, 255, 0.85)",background:"rgba(0, 0, 0, 0.15)"},a={roleWidth:150},h={menu:{joinTo:"Unir a...",deleteBtn:"Borrar",property:"Propiedades"}};(i=e=t.LogLevel||(t.LogLevel={}))[i.INFO=99]="INFO",i[i.SYSTEM=2]="SYSTEM",i[i.WARNING=1]="WARNING",i[i.DANGER=0]="DANGER",(n=t.Config||(t.Config={})).fontSize=12,n.fontType="Arial",n.selected=o,n.background="#aacccc",n.assetsPath="../assets/glyphs.png",n.regions=r,n.debug=!1,n.logLevel=e.SYSTEM,n.scrollBar=s,n.orgChart=a,n.showBanner=!0,n.workflow=h}(Loira||(Loira={}));var Relation;__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){var e=Loira.Common,i=function(i){function t(t){var e=i.call(this,t)||this;return e.type="association",e}return __extends(t,i),t}(e.Relation);t.Association=i;var n=function(i){function t(t){var e=this;return t.icon="spear",(e=i.call(this,t)||this).type="direct_association",e}return __extends(t,i),t}(e.Relation);t.DirectAssociation=n;var o=function(i){function t(t){var e=this;return t.icon="spear2",(e=i.call(this,t)||this).type="generalization",e}return __extends(t,i),t}(e.Relation);t.Generalization=o;var r=function(i){function t(t){var e=this;return t.icon="spear2",t.isDashed=!0,(e=i.call(this,t)||this).type="realization",e}return __extends(t,i),t}(e.Relation);t.Realization=r;var s=function(i){function t(t){var e=this;return t.icon="spear1",t.isDashed=!0,(e=i.call(this,t)||this).type="dependency",e}return __extends(t,i),t}(e.Relation);t.Dependency=s}(Relation||(Relation={}));var UseCase;__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){var e=Loira.Common,i=function(i){function t(t){var e=i.call(this,t)||this;return e.width=100,e.height=70,e.text=t.text,e.type="use_case",e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){var i=this.width/2,n=this.height/2,o=t.xm(),r=t.ym(),s=i*n/Math.sqrt(i*i*r*r+n*n*o*o);return Math.sqrt(Math.pow(s*r,2)+Math.pow(s*o,2))},t.prototype.render=function(t,e,i){if(t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType,this.text){var n=this.x-e,o=this.y-i,r=this.width/2*.5522848,s=this.height/2*.5522848,a=n+this.width,h=o+this.height,l=n+this.width/2,c=o+this.height/2;t.beginPath(),t.lineWidth=2,t.moveTo(n,c),t.bezierCurveTo(n,c-s,l-r,o,l,o),t.bezierCurveTo(l+r,o,a,c-s,a,c),t.bezierCurveTo(a,c+s,l+r,h,l,h),t.bezierCurveTo(l-r,h,n,c+s,n,c),t.stroke(),t.fillStyle="#fcf5d9",t.fill(),t.fillStyle="#000000",this.drawText(t,this.text,e,i)}},t.prototype.recalculateBorders=function(){},t}(e.Symbol);t.UseCase=i;var n=function(i){function t(t){var e=this;return t.icon="spear1",t.text="<< extends >>",t.isDashed=!0,(e=i.call(this,t)||this).type="extends",e}return __extends(t,i),t}(e.Relation);t.Extends=n;var o=function(i){function t(t){var e=this;return t.icon="spear1",t.text="<< include >>",t.isDashed=!0,(e=i.call(this,t)||this).type="include",e}return __extends(t,i),t}(e.Relation);t.Include=o}(UseCase||(UseCase={}));var Box;__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Loira.util.BaseOption);t.ColorOption=e;var i=function(i){function t(t){var e=i.call(this,t)||this;return e.width="width"in t?t.width:30,e.height="height"in t?t.height:30,e.color="color"in t?t.color:"rgba(0,0,0,0.3)",e.baseType="box",e}return __extends(t,i),t.prototype.render=function(t,e,i){t.fillStyle=this.color;var n=this.x-e,o=this.y-i;t.fillRect(n,o,this.width,this.height),t.fillText(this.text,n,o-10)},t.prototype.recalculateBorders=function(){},t}(Loira.Element);t.Box=i}(Box||(Box={}));var Workflow;__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(o){var t=Loira.util.BaseOption,d=Loira.util.Line,e=Loira.BaseController,i=Loira.Common,n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t);o.WorkflowOption=n;var r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.iteratorKey=0,t}return __extends(t,e),t.prototype.bind=function(o){var e=this;(this.canvas=o).defaultRelation="Workflow.Association",o.on(Loira.event.OBJECT_PRE_ADD,function(t){if("parallel_start"===t.selected.type||"parallel_end"===t.selected.type||"mono_parallel_start"===t.selected.type||"mono_parallel_end"===t.selected.type)for(var e=0,i=o.items;e<i.length;e++){var n=i[e];if(n.type==t.selected.type&&n.key==t.selected.key)return o.emit(Loira.event.ERROR_MESSAGE,{message:"Existe un nodo con la misma llave en el diagrama."}),!1}}),o.on(Loira.event.RELATION_PRE_ADD,function(t){if(("parallel_start"===t.selected.end.type||"mono_parallel_start"===t.selected.end.type)&&"returns"===t.selected.type)return o.emit(Loira.event.ERROR_MESSAGE,{message:"No es posible retornar a un nodo inicio de paralelismo."}),!1;if(("parallel_start"===t.selected.start.type||"parallel_end"===t.selected.start.type||"mono_parallel_start"===t.selected.start.type||"mono_parallel_end"===t.selected.start.type)&&"returns"===t.selected.type)return o.emit(Loira.event.ERROR_MESSAGE,{message:"No es posible retornar desde un nodo de paralelismo."}),!1;if("mono_parallel_start"===t.selected.start.type&&"process"!==t.selected.end.type&&"decision"!==t.selected.end.type)return o.emit(Loira.event.ERROR_MESSAGE,{message:"El siguiente estado de un nodo de paralelismo monotarea debe ser decisión o proceso."}),!1;if("fork_parallel"===t.selected.start.type&&"workflow_fork_continuity"===t.selected.type)for(var e=0,i=o.getRelationsFromObject(t.selected.start,!1,!0);e<i.length;e++){if("workflow_fork_continuity"===i[e].type)return o.emit(Loira.event.ERROR_MESSAGE,{message:"Ya existe una relación de continuidad para el nodo de bifurcación."}),!1}}),o.on(Loira.event.OBJECT_ADDED,function(t){"parallel_start"!==t.selected.type&&"mono_parallel_start"!==t.selected.type||t.selected.label||(e.iteratorKey++,t.selected.label=e.iteratorKey)})},t.prototype.load=function(t){},t.prototype.exportData=function(){},t.prototype.defineLabelId=function(){for(var t={},e=0,i=this.canvas.items;e<i.length;e++){"parallel_start"!==(r=i[e]).type&&"mono_parallel_start"!==r.type||t[r.key]||(t[r.key]=r.label)}for(var n=0,o=this.canvas.items;n<o.length;n++){var r;"parallel_end"!==(r=o[n]).type&&"mono_parallel_end"!==r.type||(r.label=t[r.key])}},t}(e);o.Controller=r;var s=function(n){function t(t){var e=n.call(this,t)||this;e.startPoint=!!t.startPoint&&t.startPoint,e.endPoint=!!t.endPoint&&t.endPoint;var i=e;return e.menu=[{text:Loira.Config.workflow.menu.joinTo,callback:function(){i._linkSymbol()}},{text:Loira.Config.workflow.menu.deleteBtn,callback:function(){i._canvas.remove([i])}}],e}return __extends(t,n),t.prototype._linkSymbol=function(t){var s=this,a=t||this._canvas.defaultRelation,h=this._canvas.on("mouse:down",function(t){var e=s._canvas;if(!s.maxOutGoingRelation||e.getRelationsFromObject(s,!1,!0).length<s.maxOutGoingRelation)for(var i=0,n=e.items;i<n.length;i++){var o=n[i];if("relation"!==o.baseType&&!o.startPoint&&o.checkCollision(t.x,t.y)&&!s.endPoint){var r=Loira.util.stringToFunction(a);e.add(new r({start:s,end:o}));break}}e.fall("mouse:down",h)})},t}(i.Symbol),a=function(i){function t(t){var e=this;return t.width=t.width?t.width:100,t.height=t.height?t.height:70,(e=i.call(this,t)||this).text=t.text,e.type="process",e.borders={bottomLeft:0,topLeft:0,topRight:0,bottomRight:0},e.recalculateBorders(),e.maxOutGoingRelation=1,e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){var i=t.x2-t.x1,n=t.y2-t.y1,o=Math.atan(n/i);i<0&&(o+=Math.PI);var r={x:100,y:this.y-10},s=(r=o>this.borders.bottomLeft&&o<this.borders.topLeft||o>this.borders.topRight&&o<this.borders.bottomRight?Loira.util.intersectPointLine(t,new d(this.x,-100,this.x,100)):Loira.util.intersectPointLine(t,new d(-100,this.y,100,this.y))).x-(this.x+this.width/2),a=r.y-(this.y+this.height/2);return Math.sqrt(Math.pow(s,2)+Math.pow(a,2))},t.prototype.render=function(t,e,i){t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType,t.beginPath(),t.lineWidth=2,t.rect(this.x-e,this.y-i,this.width,this.height),t.stroke(),t.fillStyle="#fcf5d9",t.fill(),t.fillStyle="#000000",this.drawText(t,this.text,e,i)},t.prototype.recalculateBorders=function(){var t=Math.round(this.width/2),e=Math.round(this.height/2);this.borders.bottomLeft=Math.atan(-e/t),this.borders.topLeft=Math.atan(e/t),this.borders.topRight=Math.atan(e/-t)+Math.PI,this.borders.bottomRight=Math.atan(-e/-t)+Math.PI},t}(o.Symbol=s);o.Process=a;var h=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.obtainBorderPos=function(t,e){var i=t.x2-t.x1,n=t.y2-t.y1,o=this.width/2,r=this.height/2,s=o*r/Math.sqrt(o*o*n*n+r*r*i*i);return Math.sqrt(Math.pow(s*n,2)+Math.pow(s*i,2))},e.prototype.render=function(t,e,i){t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType;var n=this.x-e,o=this.y-i,r=n+this.width-20,s=o+this.height;n+=20,t.beginPath(),t.lineWidth=2,t.moveTo(n,o),t.lineTo(r,o),t.bezierCurveTo(r+30,o,r+30,s,r,s),t.lineTo(n,s),t.bezierCurveTo(n-30,s,n-30,o,n,o),t.stroke(),t.fillStyle="#fcf5d9",t.fill(),t.fillStyle="#000000",this.drawText(t,this.text,e,i)},e.prototype.recalculateBorders=function(){},e}(s),l=function(i){function t(t){var e=this;return t.width=t.width?t.width:100,t.height=t.height?t.height:30,(e=i.call(this,t)||this).text="INICIO",e.startPoint=!0,e.maxOutGoingRelation=1,e.resizable=!1,e.type="start_terminator",e}return __extends(t,i),t}(o.Terminator=h);o.StartTerminator=l;var c=function(i){function t(t){var e=i.call(this,t)||this;return e.width=70,e.height=30,e.text="FIN",e.endPoint=!0,e.type="end_terminator",e.resizable=!1,e}return __extends(t,i),t}(h);o.EndTerminator=c;var u=function(i){function t(t){var e=i.call(this,t)||this;return e.width=70,e.height=30,e.text="FIN",e.endPoint=!0,e.type="end_thread_terminator",e.resizable=!1,e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){var i=t.x2-t.x1,n=t.y2-t.y1,o=this.width/2,r=this.height/2,s=o*r/Math.sqrt(o*o*n*n+r*r*i*i);return Math.sqrt(Math.pow(s*n,2)+Math.pow(s*i,2))},t.prototype.render=function(t,e,i){t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType;var n=this.x-e,o=this.y-i,r=n+this.width-20,s=o+this.height;n+=20,t.beginPath(),t.lineWidth=2,t.moveTo(n,o),t.lineTo(r,o),t.bezierCurveTo(r+30,o,r+30,s,r,s),t.lineTo(n,s),t.bezierCurveTo(n-30,s,n-30,o,n,o),t.setLineDash([5,5]),t.stroke(),t.fillStyle="#fcf5d9",t.fill(),t.fillStyle="#000000",this.drawText(t,this.text,e,i)},t.prototype.recalculateBorders=function(){},t}(s);o.ThreadTerminator=u;var p=function(i){function t(t){var e=this;return t.width=t.width?t.width:100,t.height=t.height?t.height:70,(e=i.call(this,t)||this).text=t.text,e.type="data",e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){var i=t.x2-t.x1,n=t.y2-t.y1,o=this.width/2,r=this.height/2,s=o*r/Math.sqrt(o*o*n*n+r*r*i*i);return Math.sqrt(Math.pow(s*n,2)+Math.pow(s*i,2))},t.prototype.render=function(t,e,i){t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType;var n=this.x-e,o=this.y-i,r=n+this.width,s=o+this.height;n+=20,t.beginPath(),t.lineWidth=2,t.moveTo(n,o),t.lineTo(r,o),t.lineTo(r-20,s),t.lineTo(n-20,s),t.lineTo(n,o),t.stroke(),t.fillStyle="#fcf5d9",t.fill(),t.fillStyle="#000000",this.drawText(t,this.text,e,i)},t.prototype.recalculateBorders=function(){},t}(s);o.Data=p;var f=function(i){function t(t){var e=this;return t.width=t.width?t.width:100,t.height=t.height?t.height:70,(e=i.call(this,t)||this).text=t.text,e.type="decision",e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){var i,n=t.x2-t.x1,o=t.y2-t.y1,r=this.x,s=this.y,a=this.x+this.width/2,h=this.y+this.height/2,l=this.x+this.width,c=this.y+this.height,u=Math.atan(h/n);return n<0&&(u+=Math.PI),o/=Math.abs(o),r=(i=0<u&&u<1.6?0<o?Loira.util.intersectPointLine(t,new d(r,h,a,s)):Loira.util.intersectPointLine(t,new d(r,h,a,c)):0<o?Loira.util.intersectPointLine(t,new d(a,s,l,h)):Loira.util.intersectPointLine(t,new d(a,c,l,h))).x-(this.x+this.width/2),s=i.y-(this.y+this.height/2),Math.sqrt(Math.pow(r,2)+Math.pow(s,2))},t.prototype.render=function(t,e,i){t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType;var n=this.x-e,o=this.y-i;Loira.shape.drawDiamond(t,n,o,this.width,this.height),t.fillStyle="#000000",this.drawText(t,this.text,e,i)},t.prototype.recalculateBorders=function(){},t}(s);o.Decision=f;var y=function(i){function t(t){var e=this;return t.icon="spear1",t.text=t.text||"<<returns>>",t.isDashed=!0,(e=i.call(this,t)||this).type="returns",e}return __extends(t,i),t}(i.Relation);o.Returns=y;var v=function(i){function t(t){var e=this;return t.icon="spear",(e=i.call(this,t)||this).type="workflow_association",e}return __extends(t,i),t}(i.Relation);o.Association=v;var g=function(i){function t(t){var e=this;return t.width=t.width?t.width:30,t.height=t.height?t.height:30,(e=i.call(this,t)||this).unDefined="No definido",e.resizable=!1,e.key=t.key,e.label=t.labelId,e}return __extends(t,i),t.prototype.obtainBorderPos=function(t,e){var i,n=t.x2-t.x1,o=t.y2-t.y1,r=this.x,s=this.y,a=this.x+this.width/2,h=this.y+this.height/2,l=this.x+this.width,c=this.y+this.height,u=Math.atan(h/n);return n<0&&(u+=Math.PI),o/=Math.abs(o),r=(i=0<u&&u<1.6?0<o?Loira.util.intersectPointLine(t,new d(r,h,a,s)):Loira.util.intersectPointLine(t,new d(r,h,a,c)):0<o?Loira.util.intersectPointLine(t,new d(a,s,l,h)):Loira.util.intersectPointLine(t,new d(a,c,l,h))).x-(this.x+this.width/2),s=i.y-(this.y+this.height/2),Math.sqrt(Math.pow(r,2)+Math.pow(s,2))},t.prototype.render=function(t,e,i){t.font="bold "+Loira.Config.fontSize+"px "+Loira.Config.fontType;var n=this.x-e,o=this.y-i;Loira.shape.drawDiamond(t,n,o,this.width,this.height),this.renderCustom(t,n,o)},t.prototype.recalculateBorders=function(){},t}(s),x=function(n){function t(t){var e=n.call(this,t)||this;e.type="parallel_start",e.key=e.key||Loira.util.createRandom(5);var i=e;return e.menu.push(null),e.menu.push({text:"Agregar punto de fin",callback:function(){i._canvas.add([new o.ParallelEnd({x:i.x,y:i.y+50,key:i.key,labelId:i.label})])}}),e}return __extends(t,n),t.prototype.renderCustom=function(t,e,i){t.fillStyle="#000000",t.beginPath(),t.arc(e+15,i+15,5,0,2*Math.PI,!1),t.fillStyle="#FFFFFF",t.fill(),t.lineWidth=3,t.strokeStyle="#000000",t.stroke(),t.fillStyle="#FF0000",t.fillText(this.label||this.unDefined,e+25,i+Loira.Config.fontSize-5)},t}(o.ParallelBase=g);o.ParallelStart=x;var _=function(n){function t(t){var e=n.call(this,t)||this;e.type="parallel_end",e.maxOutGoingRelation=1;var i=e;return e.menu.push(null),e.menu.push({text:"Agregar punto de inicio",callback:function(){i._canvas.add([new o.ParallelStart({x:i.x,y:i.y+50,key:i.key,labelId:i.label})])}}),e}return __extends(t,n),t.prototype.renderCustom=function(t,e,i){t.beginPath(),t.arc(e+15,i+15,5,0,2*Math.PI,!1),t.fillStyle="#000000",t.fill(),t.lineWidth=3,t.strokeStyle="#000000",t.stroke(),t.fillStyle="#FF0000",t.fillText(this.label||this.unDefined,e+25,i+Loira.Config.fontSize-5)},t}(g);o.ParallelEnd=_;var m=function(n){function t(t){var e=n.call(this,t)||this;e.type="mono_parallel_start",e.key=e.key||Loira.util.createRandom(5);var i=e;return e.maxOutGoingRelation=1,e.menu.push(null),e.menu.push({text:"Agregar punto de fin",callback:function(){i._canvas.add([new o.MonoParallelEnd({x:i.x,y:i.y+50,key:i.key,labelId:i.label})])}}),e}return __extends(t,n),t.prototype.renderCustom=function(t,e,i){t.fillStyle="#000000",t.beginPath(),t.rect(e+10,i+10,10,10),t.fillStyle="#FFFFFF",t.fill(),t.lineWidth=3,t.strokeStyle="#000000",t.stroke(),t.fillStyle="#FF0000",t.fillText(this.label||this.unDefined,e+25,i+Loira.Config.fontSize-5)},t}(g);o.MonoParallelStart=m;var w=function(n){function t(t){var e=n.call(this,t)||this;e.type="mono_parallel_end",e.maxOutGoingRelation=1;var i=e;return e.menu.push(null),e.menu.push({text:"Agregar punto de inicio",callback:function(){i._canvas.add([new o.MonoParallelStart({x:i.x,y:i.y+50,key:i.key,labelId:i.label})])}}),e}return __extends(t,n),t.prototype.renderCustom=function(t,e,i){t.beginPath(),t.rect(e+10,i+10,10,10),t.fillStyle="#000000",t.fill(),t.lineWidth=3,t.strokeStyle="#000000",t.stroke(),t.fillStyle="#FF0000",t.fillText(this.label||this.unDefined,e+25,i+Loira.Config.fontSize-5)},t}(g);o.MonoParallelEnd=w;var b=function(n){function t(t){var e=n.call(this,t)||this;e.type="fork_parallel",e.key=e.key||Loira.util.createRandom(5);var i=e;return e.menu.push(null),e.menu.push({text:"Agregar via de continuidad",callback:function(){i._linkSymbol("Workflow.ForkContinuity")}}),e}return __extends(t,n),t.prototype.renderCustom=function(t,e,i){t.fillStyle="#000000",t.beginPath(),t.moveTo(e+15,i+8),t.lineTo(e+8,i+20),t.moveTo(e+15,i+10),t.lineTo(e+15,i+20),t.moveTo(e+15,i+10),t.lineTo(e+22,i+20),t.lineWidth=3,t.strokeStyle="#000000",t.stroke()},t}(g);o.Fork=b;var C=function(i){function t(t){var e=this;return t.icon="arrow",t.isDashed=!0,(e=i.call(this,t)||this).type="workflow_fork_continuity",e}return __extends(t,i),t}(o.Association);o.ForkContinuity=C}(Workflow||(Workflow={}));var OrgChart;__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(d){var s,t=Loira.BaseController,p=Loira.util.RelOption,h=Loira.util.Rect,e=Loira.Common,o=["#124FFD","#FF4FFD","#12003D"],u=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Loira.util.BaseOption);d.RoleOption=u;var f=function(){function t(t){this.children=[],this.role=t,this.height=40}return t.prototype.recalculate=function(t){void 0===t&&(t=0),this.width=0;var e=(this.level=t)+1;s.length<=t&&s.push(this.role.height);for(var i=0;i<this.children.length;i++){var n=this.children[i];n.x=this.x+this.width,n.recalculate(e),this.width+=n.width}0===this.width&&(this.width=this.role.width+10),this.role.x=Math.floor(this.width/2-this.role.width/2)+this.x,this.role.isDuplicate||(this.role.color=o[t]),this.role.level=t,s[t]<this.role.height&&(s[t]=this.role.height)},t.prototype.getAllChildren=function(){var t=[];if(0<this.children.length)for(var e=0;e<this.children.length;e++){var i=this.children[e].getAllChildren();t.push(this.children[e]);for(var n=0;n<i.length;n++)t.push(i[n])}return t},t.prototype.getAllParent=function(){for(var t=[],e=this;e.parent;)t.push(e.parent),e=e.parent;return t},t}();d.Group=f;var i=function(n){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=!0);var i=n.call(this)||this;return i.roots=[],i.elements=[],t&&(o=t),i.autoRefresh=e,i}return __extends(t,n),t.prototype.bind=function(c){var u=this;(this.canvas=c).defaultRelation="OrgChart.Relation",c.on("object:added",function(t){var e=new f(t.selected);u.roots.push(e),u.elements.push(e),u.autoRefresh&&u.reorderElements()}),c.on("relation:pre-add",function(t){for(var e=0,i=c.getRelationsFromObject(t.selected.start,!1,!0);e<i.length;e++){if(i[e].end==t.selected.end)return!1}var n=u.getGroup(t.selected.end,u.elements).item;if(n){var o=n.getAllChildren();o.push(n);for(var r=0;r<o.length;r++)if(o[r].role.id===t.selected.start.id&&o[r].role!=t.selected.start)return!1}}),c.on("object:selected",function(t){var e=t.selected;e.isDuplicate&&(c.centerToPoint(e.rolePrimary.x,e.rolePrimary.y),c.setSelectedElement(e.rolePrimary),setTimeout(function(){c.trigger("object:selected",e.rolePrimary)},300))}),c.on("relation:added",function(t){var e=u.getGroup(t.selected.end,u.roots).index,i=u.getGroup(t.selected.end,u.elements).item,n=u.getGroup(t.selected.start,u.elements).item;if(0<=e)u.roots.splice(e,1),n.parent==i&&u.roots.push(n);else{var o=i.parent.children;e=u.getGroup(i.role,o).index,o.splice(e,1);for(var r=[],s=0,a=c.getRelationsFromObject(t.selected.end,!0,!1);s<a.length;s++){(l=a[s]).start!=n.role&&r.push(l)}0<r.length&&c.remove(r,!1)}if(n.parent==i){if(n.parent=i.parent,e=u.getGroup(n.role,i.children).index,i.children.splice(e,1),n.parent){n.parent.children.push(n);var h=new p;h.start=n.parent.role,h.end=n.role;var l=new d.Relation(h);c.add([l],!1)}c.removeRelation(i.role,n.role)}(i.parent=n).children.push(i),u.autoRefresh&&u.reorderElements()}),c.on("object:removed",function(t){var e,i,n;if("relation"===t.selected.baseType)e=t.selected,i=u.getGroup(e.end,u.elements).item;else{n=u.getGroup(t.selected,u.elements).index,i=u.elements[n],u.elements.splice(n,1);for(var o=i.getAllChildren(),r=[],s=[],a=0;a<o.length;a++)s.push(u.elements.indexOf(o[a])),r.push(o[a].role);Loira.util.removeWhole(s,u.elements),c.remove(r,!1)}i.parent?(n=u.getGroup(i.role,i.parent.children).index,i.parent.children.splice(n,1)):(n=u.getGroup(i.role,u.roots).index,u.roots.splice(n,1)),e&&(i.parent=null,u.roots.push(i)),u.autoRefresh&&u.reorderElements()})},t.prototype.load=function(t){var e,i,n,o=[],r=[],s=this.canvas.readOnly;this.canvas.readOnly=!1;for(var a=0,h=t;a<h.length;a++){var l=h[a];if((e=new u).id=l.id?l.id.toString():"",e.personName=l.personName?l.personName.toString():null,e.title=l.title?l.title.toString():null,this.getGroupById(e.id).item&&(e.isDuplicate=!0),i=new f(new y(e)),s&&i.role.on(null),l.parent){var c=this.getGroupById(l.parent?l.parent.toString():"").item;c.children.push(i),i.parent=c,(n=new p).start=c.role,n.end=i.role,r.push(new v(n))}else this.roots.push(i);this.elements.push(i),o.push(i.role)}this.canvas.add(o,!1),this.canvas.add(r,!1),this.canvas.readOnly=s},t.prototype.exportData=function(){for(var t=[],e=0,i=this.elements;e<i.length;e++){var n=i[e],o=n.parent;t.push({id:n.role.id,level:n.role.level,parent:o?o.role.id:null})}return t},t.prototype.reorderElements=function(){var t=0;s=[];for(var e=0,i=this.roots;e<i.length;e++){var n=i[e];n.x=t,n.recalculate(),t+=n.width}s[0]+=30;for(var o=1;o<s.length;o++)s[o]+=s[o-1]+30;for(o=0;o<this.elements.length;o++){var r=this.elements[o];r.role.y=0===r.level?10:s[r.level-1]}},t.prototype.getGroup=function(t,e){e||(e=this.elements);for(var i=0;i<e.length;i++)if(e[i].role==t)return{item:e[i],index:i};return{item:null,index:-1}},t.prototype.getGroupById=function(t,e){e||(e=this.elements),t=t.trim();for(var i=0;i<e.length;i++)if(""!==t&&e[i].role.id==t)return{item:e[i],index:i};return{item:null,index:-1}},t}(t);d.Controller=i;var y=function(f){function t(t){var e=f.call(this,t)||this;return e.width=Loira.Config.orgChart.roleWidth,e.height=20,e.parent=t.parent,e.title=t.title,e.resizable=!1,e.draggable=!1,e.id=t.id,e.personName=t.personName?t.personName:"",e.isDuplicate=!!t.isDuplicate&&t.isDuplicate,e.type="role",e}return __extends(t,f),t.prototype.render=function(t,e,i){f.prototype.render.call(this,t,e,i);var n,o,r,s=this.x-e,a=this.y-i,h=s+this.width/2,l=0;this.personName&&(l=((o={fontSize:Loira.Config.fontSize,lines:f.prototype.splitText.call(this,t,this.personName)}).fontSize+3)*o.lines.length+5),this.title&&(l+=((r={fontSize:Loira.Config.fontSize-(o?3:0),lines:f.prototype.splitText.call(this,t,this.title)}).fontSize+3)*r.lines.length+5),n=a+Loira.Config.fontSize,this.height=l;var c,u;if(t.fillStyle=this.isDuplicate?"#000000":this.color,t.lineWidth=4,this.isSelected?(c="#00c0ff",u=20,t.strokeStyle="#00c0ff",this.isSelected=!1):(c="#000000",u=10,t.strokeStyle="#000000"),this._canvas.userAgent!=Loira.UserAgent.FIREFOX&&(t.shadowColor=c,t.shadowBlur=u),Loira.shape.drawRoundRect(t,s,a,this.width,this.height,5),t.fillStyle="#FFFFFF",t.font=Loira.Config.fontSize+"px "+Loira.Config.fontType,o){for(var d=0;d<o.lines.length;d++){var p=t.measureText(o.lines[d]).width;t.fillText(o.lines[d],h-p/2,n+3),n=n+r.fontSize+3}n+=5,t.font="bold "+r.fontSize+"px "+Loira.Config.fontType}if(r)for(d=0;d<r.lines.length;d++){p=t.measureText(r.lines[d]).width;t.fillText(r.lines[d],h-p/2,n+3),n=n+r.fontSize+3}},t.prototype.recalculateBorders=function(){},t.prototype.obtainBorderPos=function(t,e){return 0},t.prototype.drawSelected=function(t){this.isSelected=!0,this.render(t,this._canvas.virtualCanvas.x,this._canvas.virtualCanvas.y)},t.prototype.attach=function(t){f.prototype.attach.call(this,t);var e=t.getContext(),i=0;this.personName&&(i+=(Loira.Config.fontSize+3)*f.prototype.splitText.call(this,e,this.personName).length+5),this.title&&(i+=(Loira.Config.fontSize+3-(this.personName?3:0))*f.prototype.splitText.call(this,e,this.title).length+5),this.height=i,t.readOnly&&this.on(null),this.isDuplicate&&this.setDuplicate()},t.prototype.setDuplicate=function(){for(var t=this._canvas.controller.elements,e=this._canvas.controller.getGroup(this).item.getAllParent(),i=!0,n=0;n<e.length;n++)if(this.id&&e[n].role.id===this.id){this.title=" ",this.id="",i=!1;break}if(i)for(n=0;n<t.length;n++)if(t[n].role!==this&&t[n].role.id==this.id.trim()&&!t[n].role.isDuplicate){this.isDuplicate=!0,this.on(null),this.rolePrimary=t[n].role;break}},t.prototype.update=function(t){this.title=t.title,this.id=t.id.trim(),this.setDuplicate()},t}(e.Symbol);d.Role=y;var v=function(i){function t(t){var e=i.call(this,t)||this;return e.type="orgchart:relation",e}return __extends(t,i),t.prototype.render=function(t,e,i){var n,o,r=new h(this.start.x-e,this.start.y-i,this.start.width,this.start.height),s=new h(this.end.x-e,this.end.y-i,this.end.width,this.end.height);n=s.y-10,o={x:r.x+r.width/2,y:r.y+r.height/2},this.points[0]=o,this.points[1]={x:o.x,y:n},this.points[2]={x:s.x+s.width/2,y:n},this.points[3]={x:s.x+s.width/2,y:s.y+s.height/2},t.beginPath(),t.lineWidth=4,t.strokeStyle="rgba(255,255,255,0.5)",t.moveTo(o.x,o.y),t.lineJoin="round";for(var a=1;a<this.points.length;a++)t.lineTo(this.points[a].x,this.points[a].y);t.stroke()},t}(e.Relation);d.Relation=v}(OrgChart||(OrgChart={}));